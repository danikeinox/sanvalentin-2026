---
import Layout from '../layouts/Layout.astro';
---

<Layout>
	<main class="scene">
		<div class="overlay">
			<button id="startButton" class="love-button" type="button">
				Haz Clic Amor <span aria-hidden="true">❤️</span>
			</button>
			<div id="message" class="message" aria-live="polite">
				<span>Feliz San Valentín</span>
				<small>Luz</small>
			</div>
		</div>

		<div id="heartStage" class="heart-stage" aria-hidden="true">
			<div id="heartCard" class="heart-card">
				<div class="heart-face heart-front">
					<div id="photoHeart" class="photo-heart"></div>
					<div id="hint" class="hint">Toca el corazón</div>
				</div>
				<div class="heart-face heart-back">
					<div class="red-heart" aria-hidden="true"></div>
					<div class="love-text">
						<h2>Te Amo</h2>
						<p>Estoy muy feliz de estar contigo mi amor</p>
						<div id="counter" class="counter"></div>
					</div>
				</div>
			</div>
		</div>
	</main>
</Layout>

<script>
	const startButton = document.getElementById('startButton');
	const message = document.getElementById('message');
	const heartStage = document.getElementById('heartStage');
	const heartCard = document.getElementById('heartCard');
	const photoHeart = document.getElementById('photoHeart');
	const hint = document.getElementById('hint');
	const counter = document.getElementById('counter');

	const totalPhotos = 50;
	const supportedExtensions = ['png', 'jpg', 'jpeg', 'webp', 'gif'];

	const startDate = new Date(2022, 7, 26, 0, 0, 0);

	const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

	const loadImage = (src) =>
		new Promise((resolve, reject) => {
			const img = new Image();
			img.onload = () => resolve(src);
			img.onerror = reject;
			img.src = src;
		});

	const findImageSrc = async (index) => {
		for (const ext of supportedExtensions) {
			const src = `/${index}.${ext}`;
			try {
				return await loadImage(src);
			} catch (error) {
				// keep trying other extensions
			}
		}
		return null;
	};

	const shuffle = (array) => {
		const copy = [...array];
		for (let i = copy.length - 1; i > 0; i -= 1) {
			const j = Math.floor(Math.random() * (i + 1));
			[copy[i], copy[j]] = [copy[j], copy[i]];
		}
		return copy;
	};

	const createHeartPoints = (count) => {
		const points = [];
		for (let i = 0; i < count; i += 1) {
			const t = (i / count) * Math.PI * 2;
			const x = 16 * Math.pow(Math.sin(t), 3);
			const y =
				13 * Math.cos(t) -
				5 * Math.cos(2 * t) -
				2 * Math.cos(3 * t) -
				Math.cos(4 * t);
			points.push({ x, y });
		}

		const xs = points.map((p) => p.x);
		const ys = points.map((p) => p.y);
		const minX = Math.min(...xs);
		const maxX = Math.max(...xs);
		const minY = Math.min(...ys);
		const maxY = Math.max(...ys);

		return points.map((point) => ({
			x: (point.x - minX) / (maxX - minX),
			y: 1 - (point.y - minY) / (maxY - minY),
		}));
	};

	const getStartOffset = (targetX, targetY, rect) => {
		const fromLeft = Math.random() > 0.5;
		const startX = fromLeft ? -200 : window.innerWidth + 200;
		const startY = Math.random() * window.innerHeight;
		const absoluteTargetX = rect.left + targetX;
		const absoluteTargetY = rect.top + targetY;
		return {
			x: startX - absoluteTargetX,
			y: startY - absoluteTargetY,
		};
	};

	const updateCounter = () => {
		if (!counter) return;
		const now = new Date();
		let anchor = new Date(startDate.getTime());

		let years = now.getFullYear() - anchor.getFullYear();
		const testYear = new Date(anchor.getTime());
		testYear.setFullYear(anchor.getFullYear() + years);
		if (testYear > now) {
			years -= 1;
		}
		anchor.setFullYear(anchor.getFullYear() + years);

		let months = now.getMonth() - anchor.getMonth();
		if (months < 0) months += 12;
		const testMonth = new Date(anchor.getTime());
		testMonth.setMonth(anchor.getMonth() + months);
		if (testMonth > now) {
			months -= 1;
		}
		anchor.setMonth(anchor.getMonth() + months);

		let diffMs = now - anchor;
		const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
		diffMs -= days * 1000 * 60 * 60 * 24;
		const hours = Math.floor(diffMs / (1000 * 60 * 60));
		diffMs -= hours * 1000 * 60 * 60;
		const minutes = Math.floor(diffMs / (1000 * 60));
		diffMs -= minutes * 1000 * 60;
		const seconds = Math.floor(diffMs / 1000);

		counter.textContent = `${years} años, ${months} meses, ${days} días, ${hours} horas, ${minutes} minutos y ${seconds} segundos`;
	};

	const buildHeart = async () => {
		if (!photoHeart) return;
		photoHeart.innerHTML = '';
		hint?.classList.remove('show');

		const imageSources = await Promise.all(
			Array.from({ length: totalPhotos }, (_, index) => findImageSrc(index + 1))
		);

		const validSources = imageSources
			.map((src, index) => ({ src, index }))
			.filter((item) => item.src);

		const points = shuffle(createHeartPoints(validSources.length));
		const rect = photoHeart.getBoundingClientRect();
		const padding = rect.width * 0.08;

		validSources.forEach((item, i) => {
			const point = points[i];
			const targetX = padding + point.x * (rect.width - padding * 2);
			const targetY = padding + point.y * (rect.height - padding * 2);
			const startOffset = getStartOffset(targetX, targetY, rect);

			const img = document.createElement('img');
			img.className = 'photo';
			img.alt = `Recuerdo ${item.index + 1}`;
			img.src = item.src;
			img.style.left = `${targetX}px`;
			img.style.top = `${targetY}px`;
			img.style.setProperty('--start-x', `${startOffset.x}px`);
			img.style.setProperty('--start-y', `${startOffset.y}px`);
			img.style.setProperty('--delay', `${i * 60}ms`);

			photoHeart.appendChild(img);

			requestAnimationFrame(() => {
				img.classList.add('arrived');
			});
		});

		const totalDuration = validSources.length * 60 + 1400;
		await sleep(totalDuration);
		heartStage?.classList.add('ready');
		hint?.classList.add('show');
	};

	updateCounter();
	setInterval(updateCounter, 1000);

	const startSequence = async () => {
		startButton?.setAttribute('disabled', 'true');
		startButton?.classList.add('hidden');
		message?.classList.add('show');
		await sleep(1600);
		message?.classList.add('hide');
		await sleep(400);
		heartStage?.classList.add('visible');
		await sleep(300);
		await buildHeart();
	};

	startButton?.addEventListener('click', startSequence);

	heartStage?.addEventListener('click', () => {
		if (!heartStage.classList.contains('ready')) return;
		heartCard?.classList.toggle('flipped');
	});
</script>

<style>
	.scene {
		min-height: 100vh;
		display: flex;
		align-items: center;
		justify-content: center;
		position: relative;
		overflow: hidden;
		padding: 2rem;
	}

	.scene::before {
		content: '';
		position: absolute;
		inset: 0;
		background-image:
			radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.06), transparent 55%),
			radial-gradient(circle at 80% 0%, rgba(255, 255, 255, 0.05), transparent 50%),
			repeating-linear-gradient(
				45deg,
				rgba(255, 255, 255, 0.015),
				rgba(255, 255, 255, 0.015) 2px,
				transparent 2px,
				transparent 6px
			);
		opacity: 0.7;
		pointer-events: none;
	}

	.overlay {
		position: absolute;
		inset: 0;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		gap: 1.5rem;
		z-index: 2;
		pointer-events: none;
		text-align: center;
	}

	.love-button {
		pointer-events: auto;
		background: linear-gradient(135deg, #e11d48, #f97316);
		color: #fff;
		border: none;
		padding: 1rem 2.8rem;
		font-size: clamp(1.1rem, 2.4vw, 1.6rem);
		border-radius: 999px;
		box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
		letter-spacing: 0.03em;
		cursor: pointer;
		transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
	}

	.love-button span {
		margin-left: 0.6rem;
	}

	.love-button:hover {
		transform: translateY(-2px) scale(1.02);
		box-shadow: 0 24px 50px rgba(0, 0, 0, 0.4);
	}

	.love-button.hidden {
		opacity: 0;
		pointer-events: none;
		transform: translateY(10px) scale(0.98);
	}

	.message {
		font-size: clamp(2.2rem, 6vw, 4rem);
		font-weight: 700;
		opacity: 0;
		transform: translateY(12px);
		transition: opacity 0.6s ease, transform 0.6s ease;
		display: flex;
		flex-direction: column;
		gap: 0.3rem;
		text-shadow: 0 10px 25px rgba(0, 0, 0, 0.45);
	}

	.message small {
		font-size: clamp(1.1rem, 3vw, 1.8rem);
		font-weight: 400;
		letter-spacing: 0.08em;
	}

	.message.show {
		opacity: 1;
		transform: translateY(0);
	}

	.message.hide {
		opacity: 0;
		transform: translateY(-12px);
	}

	.heart-stage {
		width: min(80vmin, 720px);
		height: min(80vmin, 720px);
		perspective: 1200px;
		opacity: 0;
		transform: scale(0.96);
		transition: opacity 0.6s ease, transform 0.6s ease;
		z-index: 1;
		pointer-events: none;
	}

	.heart-stage.visible {
		opacity: 1;
		transform: scale(1);
		pointer-events: auto;
	}

	.heart-card {
		position: relative;
		width: 100%;
		height: 100%;
		transform-style: preserve-3d;
		transition: transform 1s ease;
	}

	.heart-card.flipped {
		transform: rotateY(180deg);
	}

	.heart-face {
		position: absolute;
		inset: 0;
		display: flex;
		align-items: center;
		justify-content: center;
		backface-visibility: hidden;
	}

	.heart-front {
		padding: 2rem;
	}

	.heart-back {
		transform: rotateY(180deg);
		flex-direction: column;
		gap: 1.5rem;
		text-align: center;
	}

	.photo-heart {
		position: relative;
		width: 100%;
		height: 100%;
	}

	.photo {
		position: absolute;
		width: clamp(32px, 6vmin, 64px);
		height: clamp(32px, 6vmin, 64px);
		object-fit: cover;
		border-radius: 12px;
		opacity: 0;
		transform: translate3d(var(--start-x), var(--start-y), 0) scale(0.3);
		transition:
			transform 1.2s ease,
			opacity 1s ease;
		transition-delay: var(--delay);
		box-shadow: 0 18px 30px rgba(0, 0, 0, 0.4);
	}

	.photo.arrived {
		opacity: 1;
		transform: translate3d(0, 0, 0) scale(1);
	}

	.heart-stage.ready .photo-heart {
		cursor: pointer;
	}

	.hint {
		position: absolute;
		bottom: 1.2rem;
		font-size: 0.9rem;
		letter-spacing: 0.2em;
		text-transform: uppercase;
		opacity: 0;
		transition: opacity 0.6s ease;
	}

	.hint.show {
		opacity: 0.75;
	}

	.red-heart {
		width: min(45vmin, 320px);
		height: min(45vmin, 320px);
		position: relative;
		background: #e11d48;
		transform: rotate(-45deg);
		border-radius: 20px;
		box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
	}

	.red-heart::before,
	.red-heart::after {
		content: '';
		position: absolute;
		width: 100%;
		height: 100%;
		background: #e11d48;
		border-radius: 50%;
	}

	.red-heart::before {
		top: -50%;
		left: 0;
	}

	.red-heart::after {
		left: 50%;
		top: 0;
	}

	.love-text {
		max-width: 420px;
		display: flex;
		flex-direction: column;
		gap: 0.8rem;
		align-items: center;
	}

	.love-text h2 {
		margin: 0;
		font-size: clamp(2rem, 4vw, 3rem);
		color: #ffdce1;
	}

	.love-text p {
		margin: 0;
		font-size: clamp(1rem, 2.2vw, 1.2rem);
		color: #f9d2d7;
	}

	.counter {
		font-size: clamp(0.9rem, 2.2vw, 1.05rem);
		color: #fbd0d6;
		padding: 0.8rem 1.2rem;
		border-radius: 999px;
		background: rgba(225, 29, 72, 0.2);
		border: 1px solid rgba(255, 255, 255, 0.15);
	}

	@media (max-width: 600px) {
		.love-button {
			padding: 0.9rem 2rem;
		}

		.heart-front {
			padding: 1rem;
		}
	}
</style>
